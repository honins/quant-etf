# 🧠 算法原理与计算流程详解 (Algorithm Details)

本文档详细拆解本系统（Quant-ETF）的核心算法逻辑，从原始数据处理到最终发出交易信号的全过程。

---

## 1. 数据处理流 (Data Pipeline)

系统的第一步是将非结构化的市场数据转化为算法可理解的特征矩阵。

### 1.1 数据获取
*   **源头**: Tushare Pro 接口。
*   **频率**: 日线 (Daily)。
*   **原始字段**: 开盘价(Open), 最高价(High), 最低价(Low), 收盘价(Close), 成交量(Vol)。
*   **复权**: 默认使用**后复权**或**不复权**数据（ETF分红较少，影响不大，主要看趋势）。

### 1.2 特征工程 (Feature Engineering)
我们选取了 **12 个核心技术指标** 作为 AI 模型的输入（Features）。这些指标旨在捕捉趋势、动能、波动率和资金流向。

| 类别 | 指标名 | 计算公式 (Python/Pandas) | 业务含义 |
| :--- | :--- | :--- | :--- |
| **趋势** | **MA5** | `close.rolling(5).mean()` | 短期成本线 |
| | **MA20** | `close.rolling(20).mean()` | 中期生命线 |
| | **MA60** | `close.rolling(60).mean()` | 长期牛熊分界 |
| **动能** | **RSI_6** | 基于6日涨跌幅比率计算 (0-100) | 短期超买超卖 |
| | **RSI_14** | 基于14日涨跌幅比率计算 (0-100) | 中期强弱指标 |
| | **MACD** | `EMA(12) - EMA(26)` | 异同移动平均线，判断趋势强度 |
| | **MACD_Signal** | `MACD.ewm(9).mean()` | MACD的信号线 |
| | **MACD_Hist** | `MACD - Signal` | 红绿柱，判断金叉/死叉 |
| **波动** | **ATR** | `Max(H-L, |H-C_pre|, |L-C_pre|).rolling(14).mean()` | 平均真实波幅，衡量市场活跃度 |
| | **Upper** | `MA20 + 2*StdDev` | 布林带上轨 (压力位) |
| | **Lower** | `MA20 - 2*StdDev` | 布林带下轨 (支撑位) |
| **资金** | **OBV** | `CumSum(Vol * sign(Close - Close_pre))` | 能量潮，判断资金是否进场 |

---

## 2. AI 核心模型: XGBoost

本系统使用 **XGBoost (eXtreme Gradient Boosting)** 作为核心预测引擎。

### 2.1 训练目标 (Label)
我们并不是预测“明天的价格是多少”（回归问题），而是预测**“未来是否有波段机会”**（分类问题）。
*   **标签定义**: 如果 `(未来5天最高价 / 当前收盘价 - 1) > 2%`，则标记为 **1 (是机会)**，否则为 **0**。
*   **含义**: 寻找未来一周内至少有 2% 上涨空间的买点。

### 2.2 模型训练
*   **算法**: 梯度提升树 (Gradient Boosting Decision Tree)。
*   **原理**: 训练数百棵决策树，每一棵树都在修正前一棵树的预测误差。
*   **输入**: 上述 12 个技术指标的数值。
*   **输出**: 一个 `0.0 ~ 1.0` 的概率值，表示“未来上涨 > 2%”的可能性。

### 2.3 为什么有效？
XGBoost 能够自动学习指标之间的**非线性关系**。例如：
*   *规则模型*: "RSI < 30 就买"。
*   *XGBoost*: "如果 RSI < 30，但同时 MA60 向下且 OBV 流出，**不买**；如果 RSI < 30 且成交量突然放大 2 倍，**重仓买**"。

---

## 3. 混合决策策略 (Hybrid Strategy)

AI 给出评分后，我们不会盲目执行，而是结合**规则引擎**进行风控。

### 3.1 第一层：大盘风控 (Market Filter)
我们使用 **沪深300指数 (000300.SH)** 来判断市场环境。
*   **牛市 (Bull)**: 大盘收盘价 > 60日均线。
*   **熊市 (Bear)**: 大盘收盘价 <= 60日均线。

### 3.2 第二层：动态阈值 (Dynamic Threshold)
根据大盘状态，动态调整对 AI 评分的要求：

| 市场环境 | 策略逻辑 | 买入阈值 (Score) | 含义 |
| :--- | :--- | :--- | :--- |
| **🐂 牛市** | **进攻模式** | **>= 0.45** | 只要 AI 觉得还可以，就大胆上车，不错过行情。 |
| **🐻 熊市** | **防守模式** | **>= 0.75** | 除非 AI 极度确信（超高分），否则空仓观望。 |

---

## 4. 交易执行与风控 (Execution)

一旦触发买入信号，系统将生成具体的交易计划。

### 4.1 初始止损 (ATR Stop-Loss)
我们不使用固定百分比止损（如 -5%），而是使用 **ATR (波动率)** 动态止损。
*   **公式**: `止损价 = 买入价 - (2.0 * ATR)`
*   **逻辑**: 如果当前 ATR 是 0.05，说明市场正常波动范围是 0.05。我们设 2 倍 ATR，是为了避免被正常的市场噪音震出局。只有跌幅超过噪音范围，才认为是趋势坏了。

### 4.2 移动止盈 (Chandelier Exit)
当价格上涨时，止损线会跟随上移，**只上不下**。
*   **公式**: `止盈价 = 过去22天最高价 - (2.0 * ATR)`
*   **效果**:
    *   买入后价格大涨，"过去22天最高价" 创新高，止盈线随之抬升，锁定利润。
    *   价格高位回落，止盈线不变。
    *   当价格跌破止盈线时，**强制离场**，吃完鱼身，放弃鱼尾。

---

## 5. 总结

整个系统的计算流如下：

1.  **Input**: 每日收盘后，拉取 ETF 和大盘数据。
2.  **Calc**: 计算 12 个技术指标。
3.  **Predict**: XGBoost 模型根据指标算出 `Score` (0~1)。
4.  **Filter**:
    *   看大盘：是牛是熊？
    *   定阈值：是 0.45 还是 0.75？
5.  **Decision**: `Score > Threshold` ? **买入** : **观望**。
6.  **Risk**: 如果持仓，计算最新的 ATR 止损位，破位即卖。

---

## 6. 实操指南 (User Guide)

了解算法原理后，您可以通过以下步骤获取具体的买卖信号：

### 6.1 生成报告
在项目根目录下运行：
```bash
python main.py
```
程序运行结束后，会在 `reports/` 目录下生成当天的分析报告（例如 `daily_report_2026-01-23.md`）。

### 6.2 识别买入点
打开报告，查看 **"🚀 重点关注 (Score >= 0.6)"** 章节：
*   如果某标的出现 **"💡 决策建议: 买入"**，且当前价格适合，可考虑建仓。

### 6.3 识别卖出点
对于您已持有的标的，请关注报告中的 **"🛡️ 风控建议"** 部分：
*   **初始止损**: 报告会给出具体的止损价格（如 `1.234`）。如果收盘价跌破此价格，应果断卖出。
*   **移动止盈**: 报告会给出动态的止盈保护价。
*   **操作原则**: 取 **初始止损** 和 **移动止盈** 中的 **较高者** 作为当前的防守线。一旦价格跌破该线，即为卖出信号。
